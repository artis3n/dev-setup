- name: Terraform | Get latest release
  set_fact:
    terraform_version: "{{ lookup('artis3n.github.latest_release', 'hashicorp/terraform')[1:] }}"

- name: Terraform | Set archive path
  set_fact:
    terraform_archive_path: '{{ install_dir }}/terraform_{{ terraform_version }}.zip'

- name: Terraform | Ensure directory
  file:
    path: '{{ install_dir }}/terraform_{{ terraform_version }}'
    state: directory
  register: terraform_directory

- name: Terraform | Check for download
  stat:
    path: '{{ terraform_archive_path }}'
  register: terraform_archive

- name: Terraform | Download
  get_url:
    url: https://releases.hashicorp.com/terraform/{{ terraform_version }}/terraform_{{ terraform_version }}_{{ os_short }}.zip
    dest: '{{ terraform_archive_path }}'
  when: not terraform_archive.stat.exists

- name: Terraform | Unarchive
  unarchive:
    src: '{{ terraform_archive_path }}'
    remote_src: yes
    dest: '{{ terraform_directory.path }}'
    creates: '{{ terraform_directory.path }}/terraform'

- name: Terraform | Ensure local bin permissions
  become: 'yes'
  file:
    path: /usr/local
    state: directory
    owner: '{{ ansible_user }}'
    group: '{{ ansible_user }}'
    recurse: 'yes'

- name: Terraform | Add to local bin
  file:
    src: '{{ terraform_directory.path }}/terraform'
    dest: /usr/local/bin/terraform
    state: link
